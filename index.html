
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Экзамен — тест</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; max-width: 920px; margin: 24px auto; padding: 0 16px; }
    .card { border: 1px solid #e6e6e6; border-radius: 14px; padding: 16px; margin: 12px 0; background: #fff; }
    .muted { color:#666; }
    input[type="text"] { padding: 10px 12px; border: 1px solid #ddd; border-radius: 10px; width: 320px; max-width: 100%; }
    .q-title { font-weight: 700; margin: 0 0 10px; }
    .opt { display: block; padding: 10px 12px; border: 1px solid #eee; border-radius: 12px; margin: 8px 0; cursor: pointer; }
    .opt:hover { border-color:#d5d5d5; }
    .actions { position: sticky; bottom: 0; background: rgba(255,255,255,0.92); backdrop-filter: blur(6px); border-top: 1px solid #eee; padding: 12px 0; margin-top: 18px; }
    .actions-inner { max-width: 920px; margin: 0 auto; padding: 0 16px; display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    button { padding: 11px 16px; border-radius: 12px; border: 1px solid #111; background: #111; color:#fff; cursor: pointer; font-weight: 800; }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .status { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; margin-top: 10px; }
    .bad { color:#b00020; }
    .good { color:#0a7a2f; }
  </style>
</head>
<body>

  <h1>Экзаменационный тест</h1>
  

  <div class="card">
    <label><strong>ФИО:</strong></label><br/>
    <input id="name" type="text" placeholder="Например, Иванов И.И." />
    <div class="status" id="status"></div>
  </div>

  <div id="quiz"></div>

  <div class="actions">
    <div class="actions-inner">
      <div id="progress" class="muted">Ответов: 0/10</div>
      <button id="submitBtn" disabled>Отправить</button>
    </div>
  </div>
<div id="memeBox" class="card" style="display:none;">
  <div id="memeText" style="font-weight:700; margin-bottom:10px;"></div>
  <img id="memeImg" alt="meme" style="max-width:100%; border-radius:14px; border:1px solid #eee;">
</div>

<script>
const API_URL = "https://quiz-api-krqu.onrender.com";
const MEMES = [
  { min: 0,  max: 3,  img: "https://img01.rl0.ru/afisha/e750x-i/daily.afisha.ru/uploads/images/b/25/b2586f8eb5561542e587aded807478e8.jpg",  text: "беда..беда" },
  { min: 4,  max: 7,  img: "https://i.pinimg.com/236x/19/b9/86/19b98673e7fdbc6955fc31e1fa7edc74.jpg",    text: "Ну, ладно" },
  { min: 8,  max: 10, img: "https://www.meme-arsenal.com/memes/8c1c72ad4433bbd78c8d3189ee070767.jpg",   text: "Удивительно" },
];

function pickMeme(score, total) {
  // если вдруг total не 10, можно ориентироваться на проценты:
  // const pct = Math.round((score / total) * 100);
  return MEMES.find(m => score >= m.min && score <= m.max) || null;
}

// ограничение "раз в сутки" в этом браузере (можешь убрать)
const SUBMIT_TS_KEY = "exam_last_submit_ts_v1";
const COOLDOWN_MS = 24 * 60 * 60 * 1000;

let examId = null;
let questions = [];

function setStatus(text, kind) {
  const el = document.getElementById("status");
  el.textContent = text || "";
  el.className = "status " + (kind || "");
}

function getLastSubmitTs() {
  const v = localStorage.getItem(SUBMIT_TS_KEY);
  return v ? Number(v) : 0;
}
function canSubmitNow() {
  const last = getLastSubmitTs();
  if (!last) return { ok: true, leftMs: 0 };
  const leftMs = (last + COOLDOWN_MS) - Date.now();
  return { ok: leftMs <= 0, leftMs: Math.max(0, leftMs) };
}
function formatLeft(ms) {
  const totalSec = Math.ceil(ms / 1000);
  const h = Math.floor(totalSec / 3600);
  const m = Math.floor((totalSec % 3600) / 60);
  const s = totalSec % 60;
  return `${h}ч ${m}м ${s}с`;
}

function render() {
  const quiz = document.getElementById("quiz");
  quiz.innerHTML = "";

  questions.forEach((q, i) => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `<div class="q-title">${i+1}. ${q.text}</div>`;

    q.options.forEach((opt, oi) => {
      const optId = `q${q.id}_o${opt.id}`;
      const label = document.createElement("label");
      label.className = "opt";
      label.htmlFor = optId;
      label.innerHTML = `
        <input id="${optId}" type="radio" name="q_${q.id}" value="${opt.id}">
        <span style="margin-left:8px;">${opt.text}</span>
      `;
      card.appendChild(label);
    });

    quiz.appendChild(card);
  });

  updateProgress();
}

function getAnsweredCount() {
  let c = 0;
  for (const q of questions) {
    const checked = document.querySelector(`input[name="q_${q.id}"]:checked`);
    if (checked) c++;
  }
  return c;
}

function updateProgress() {
  const answered = getAnsweredCount();
  const total = questions.length;
  document.getElementById("progress").textContent = `Ответов: ${answered}/${total}`;

  const gate = canSubmitNow();
  const btn = document.getElementById("submitBtn");

  if (!gate.ok) {
    btn.disabled = true;
    setStatus(`Повторная отправка доступна через: ${formatLeft(gate.leftMs)}`, "bad");
    return;
  }

  // все обязательны
  btn.disabled = answered !== total;
}

document.addEventListener("change", (e) => {
  if (e.target && e.target.matches('input[type="radio"]')) updateProgress();
});

function collectAnswersRequired() {
  const answers = {};
  for (const q of questions) {
    const checked = document.querySelector(`input[name="q_${q.id}"]:checked`);
    if (!checked) return null;
    answers[String(q.id)] = Number(checked.value); // option_id
  }
  return answers;
}

async function loadExam() {
  setStatus("Загрузка вопросов...", "");
  const res = await fetch(API_URL + "/exam");
  const data = await res.json();
  if (!res.ok) {
    setStatus("Ошибка загрузки:\n" + JSON.stringify(data, null, 2), "bad");
    return;
  }
  examId = data.exam_id;
  questions = data.questions;
  setStatus("", "");
  render();
}

async function submit() {
  const gate = canSubmitNow();
  if (!gate.ok) {
    setStatus(`Повторная отправка доступна через: ${formatLeft(gate.leftMs)}`, "bad");
    return;
  }

  const name = document.getElementById("name").value.trim();
  if (!name) {
    setStatus("Введите ФИО/ник.", "bad");
    return;
  }

  const answers = collectAnswersRequired();
  if (!answers) {
    setStatus("Ответьте на все вопросы.", "bad");
    return;
  }

  const payload = { name, exam_id: examId, answers };

  setStatus("Отправка...", "");
  const btn = document.getElementById("submitBtn");
  btn.disabled = true;

  try {
    const res = await fetch(API_URL + "/submit", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      setStatus("Ошибка сервера:\n" + JSON.stringify(data, null, 2), "bad");
      btn.disabled = false;
      return;
    }

    // блокируем на сутки (локально)
    localStorage.setItem(SUBMIT_TS_KEY, String(Date.now()));

    setStatus(`✅ Отправлено!\nРезультат: ${data.score}/${questions.length}`, "good");
    
const meme = pickMeme(data.score, questions.length);
if (meme) {
  const box = document.getElementById("memeBox");
  document.getElementById("memeText").textContent = `${meme.text} (${data.score}/${questions.length})`;
  document.getElementById("memeImg").src = meme.img;
  box.style.display = "block";
}

    // блокируем изменения после отправки
    document.querySelectorAll('input[type="radio"], input[type="text"]').forEach(el => el.disabled = true);

  } catch (e) {
    setStatus("Ошибка отправки:\n" + String(e), "bad");
    btn.disabled = false;
  }
}

document.getElementById("submitBtn").addEventListener("click", submit);

loadExam();
</script>
</body>
</html>

